// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  emailVerified DateTime?
  image         String?
  phone         String? // Phone number for SMS notifications (E.164 format: +1234567890)
  phoneVerified Boolean   @default(false)
  role          String    @default("user") // "user", "admin"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  products         Product[]
  subscriptions    Subscription[]
  notifications    Notification[]
  contactResponses ContactResponse[]
  payments         Payment[]
  emailCampaigns   EmailCampaign[]

  // Affiliate relations
  affiliateCode           AffiliateCode?
  referredByAffiliateCode String? // Code used during registration
  referredBy              AffiliateReferral[]   @relation("ReferredUsers")
  affiliateReferrals      AffiliateReferral[]   @relation("AffiliateUser")
  affiliateCommissions    AffiliateCommission[]
  pushSubscriptions       PushSubscription[]
  passwordResetTokens     PasswordResetToken[]
  smsUsage                SMSUsage[]
  phoneVerifications      PhoneVerification[]

  @@map("users")
}

model Product {
  id           String    @id @default(cuid())
  name         String
  url          String
  type         String // "website", "domain", "ssl", "api"
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status       String    @default("active") // "active", "expired", "warning"
  expiresAt    DateTime?
  lastChecked  DateTime  @default(now())
  customFields Json? // Custom fields to check (e.g., {"expectedText": "Welcome", "statusCode": 200, "responseTime": 1000})
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  checks Check[]

  @@map("products")
}

model Check {
  id           String  @id @default(cuid())
  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  status       String // "success", "error", "warning"
  message      String?
  responseTime Int? // Response time in milliseconds
  statusCode   Int? // HTTP status code
  errorCode    String? // Error code (e.g., ENOTFOUND, ECONNREFUSED, CERT_HAS_EXPIRED)
  errorDetails Json? // Additional error details

  // Enhanced data collection fields
  httpHeaders Json? // HTTP response headers
  dnsInfo     Json? // DNS lookup information (A, AAAA, CNAME, MX records)
  sslInfo     Json? // SSL certificate details (issuer, expiry, subject, etc.)
  apiResponse Json? // API response data (parsed JSON/XML)
  contentInfo Json? // Content verification info (title, meta, text found)
  performance Json? // Performance metrics (dnsTime, connectTime, sslTime, etc.)
  networkInfo Json? // Network information (ipAddress, server, location hints)

  checkedAt DateTime @default(now())

  @@map("checks")
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  status               String // "active", "canceled", "past_due", "trialing"
  planId               String
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  payments Payment[]

  @@map("subscriptions")
}

model Payment {
  id                    String        @id @default(cuid())
  userId                String
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionId        String?
  subscription          Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  stripePaymentIntentId String?       @unique
  stripeInvoiceId       String?       @unique
  amount                Int // Amount in cents
  currency              String        @default("usd")
  status                String // "succeeded", "pending", "failed", "refunded"
  description           String?
  planId                String?
  periodStart           DateTime?
  periodEnd             DateTime?
  createdAt             DateTime      @default(now())

  affiliateCommission AffiliateCommission?

  @@map("payments")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // "email", "push", "in_app"
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("notifications")
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String
  status    String   @default("new") // "new", "read", "replied", "archived"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  responses ContactResponse[]

  @@map("contact_messages")
}

model ContactResponse {
  id               String         @id @default(cuid())
  contactMessageId String
  contactMessage   ContactMessage @relation(fields: [contactMessageId], references: [id], onDelete: Cascade)
  userId           String
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  message          String
  createdAt        DateTime       @default(now())

  @@map("contact_responses")
}

model EmailCampaign {
  id              String    @id @default(cuid())
  createdBy       String
  creator         User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  subject         String
  content         String // HTML content
  recipientType   String // "all", "active", "trialing", "canceled", "custom"
  recipientEmails Json? // Custom email list if recipientType is "custom"
  status          String    @default("draft") // "draft", "scheduled", "sending", "sent", "failed"
  sentCount       Int       @default(0)
  failedCount     Int       @default(0)
  totalRecipients Int       @default(0)
  scheduledAt     DateTime?
  sentAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  opens  CampaignOpen[]
  clicks CampaignClick[]

  @@map("email_campaigns")
}

model CampaignOpen {
  id         String        @id @default(cuid())
  campaignId String
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  email      String // Recipient email
  openedAt   DateTime      @default(now())
  ipAddress  String?
  userAgent  String?

  @@index([campaignId])
  @@index([email])
  @@index([openedAt])
  @@map("campaign_opens")
}

model CampaignClick {
  id         String        @id @default(cuid())
  campaignId String
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  email      String // Recipient email
  url        String // Clicked URL
  clickedAt  DateTime      @default(now())
  ipAddress  String?
  userAgent  String?

  @@index([campaignId])
  @@index([email])
  @@index([clickedAt])
  @@map("campaign_clicks")
}

model Visitor {
  id         String   @id @default(cuid())
  sessionId  String   @unique // Unique session identifier
  ipAddress  String?
  userAgent  String?
  country    String?
  city       String?
  referrer   String? // Where they came from
  firstVisit DateTime @default(now())
  lastVisit  DateTime @default(now())
  visitCount Int      @default(1)

  visits Visit[]

  @@map("visitors")
}

model Visit {
  id        String   @id @default(cuid())
  visitorId String
  visitor   Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  path      String // Page path (e.g., "/", "/pricing", "/dashboard")
  referrer  String? // HTTP referrer
  duration  Int? // Time spent on page in seconds
  createdAt DateTime @default(now())

  @@index([visitorId])
  @@index([path])
  @@index([createdAt])
  @@map("visits")
}

model AffiliateCode {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code           String   @unique // Unique referral code
  isActive       Boolean  @default(true)
  totalReferrals Int      @default(0)
  totalEarnings  Int      @default(0) // Total earnings in cents
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  referrals   AffiliateReferral[]
  commissions AffiliateCommission[]

  @@index([code])
  @@map("affiliate_codes")
}

model AffiliateReferral {
  id              String        @id @default(cuid())
  affiliateCodeId String
  affiliateCode   AffiliateCode @relation(fields: [affiliateCodeId], references: [id], onDelete: Cascade)
  affiliateUserId String // User who owns the affiliate code
  affiliateUser   User          @relation("AffiliateUser", fields: [affiliateUserId], references: [id], onDelete: Cascade)
  referredUserId  String        @unique // User who was referred
  referredUser    User          @relation("ReferredUsers", fields: [referredUserId], references: [id], onDelete: Cascade)
  status          String        @default("pending") // "pending", "completed", "converted"
  hasConverted    Boolean       @default(false) // Has the referred user subscribed?
  createdAt       DateTime      @default(now())
  convertedAt     DateTime?

  commission AffiliateCommission?

  @@index([affiliateCodeId])
  @@index([affiliateUserId])
  @@index([referredUserId])
  @@index([status])
  @@map("affiliate_referrals")
}

model AffiliateCommission {
  id              String            @id @default(cuid())
  affiliateCodeId String
  affiliateCode   AffiliateCode     @relation(fields: [affiliateCodeId], references: [id], onDelete: Cascade)
  affiliateUserId String
  affiliateUser   User              @relation(fields: [affiliateUserId], references: [id], onDelete: Cascade)
  referralId      String            @unique
  referral        AffiliateReferral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  paymentId       String?           @unique // Related payment if commission is from subscription
  payment         Payment?          @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  amount          Int // Commission amount in cents
  commissionType  String // "signup", "subscription", "recurring"
  status          String            @default("pending") // "pending", "approved", "paid", "cancelled"
  commissionRate  Float // Percentage or fixed rate
  createdAt       DateTime          @default(now())
  approvedAt      DateTime?
  paidAt          DateTime?

  @@index([affiliateCodeId])
  @@index([affiliateUserId])
  @@index([status])
  @@index([createdAt])
  @@map("affiliate_commissions")
}

model NewsletterSubscriber {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  source         String? // "landing_page", "contact_form", "manual", etc.
  status         String    @default("active") // "active", "unsubscribed", "bounced"
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  metadata       Json? // Additional data (IP, user agent, etc.)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([email])
  @@index([status])
  @@index([subscribedAt])
  @@map("newsletter_subscribers")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique // Push service endpoint URL
  p256dh    String // User public key
  auth      String // User auth secret
  userAgent String? // Browser user agent
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([enabled])
  @@map("push_subscriptions")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model SMSUsage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month     Int // Month (1-12)
  year      Int // Year (e.g., 2024)
  count     Int      @default(0) // Number of SMS sent this month
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, month, year])
  @@index([userId])
  @@index([year, month])
  @@map("sms_usage")
}

model PhoneVerification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone     String   // Phone number in E.164 format
  code      String   // 6-digit verification code
  expiresAt DateTime // Code expiration time (10 minutes)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("phone_verifications")
  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}
